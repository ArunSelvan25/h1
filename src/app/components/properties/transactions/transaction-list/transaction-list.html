<div class="p-6 bg-white space-y-6">
  <!-- Header -->
  <div class="flex justify-between items-center">
    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
      Transaction History
    </h2>
    @if (propertyService.tenantForm.get('phone')?.value) {
      <button
        (click)="addTransaction(propertyService.viewedPropertyId())"
        class="px-5 py-2 bg-primary hover:bg-primary-dark text-white text-sm rounded-lg font-semibold shadow transition"
      >
        ➕ Add Transaction
      </button>
    }
  </div>

  <!-- Table -->
  <div class="overflow-x-auto border border-gray-200">
    <table class="min-w-full divide-y divide-gray-200 text-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left font-semibold text-gray-700">Date</th>
          <th class="px-6 py-3 text-left font-semibold text-gray-700">Name</th>
          <th class="px-6 py-3 text-left font-semibold text-gray-700">Phone</th>
          <th class="px-6 py-3 text-left font-semibold text-gray-700">Amount</th>
          <th class="px-6 py-3 text-left font-semibold text-gray-700">Status</th>
          <th class="px-6 py-3 text-left font-semibold text-gray-700">Actions</th>
        </tr>
      </thead>

      <tbody class="bg-white divide-y divide-gray-100">
        @if (listData.length) {
          @for (txn of listData; track $index) {
            <tr class="hover:bg-gray-50 transition">
              <td
                (click)="toggleExpand($index)"
                class="px-6 py-4 flex items-center gap-2 cursor-pointer text-gray-700"
              >
                <span class="text-xl">
                  @if (expandedRows.has($index)) { ▾ } @else { ▸ }
                </span>
                {{ txn.date | date: 'mediumDate' }}
              </td>
              <td class="px-6 py-4 font-medium text-gray-800">{{ txn.tenant.name }}</td>
              <td class="px-6 py-4 text-gray-600">{{ txn.tenant.phone }}</td>
              <td class="px-6 py-4 font-semibold text-green-600">
                ₹{{ txn.amount | number: '1.2-2' }}
              </td>
              <td class="px-6 py-4">
                <span
                  class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium"
                  [ngClass]="{
                    'bg-green-100 text-green-700': txn.status === 'Paid',
                    'bg-yellow-100 text-yellow-700': txn.status === 'Pending',
                    'bg-red-100 text-red-700': txn.status === 'Failed'
                  }"
                >
                  @if (txn.status === 'Paid') { ✅ }
                  @if (txn.status === 'Pending') { ⏳ }
                  @if (txn.status === 'Failed') { ❌ }
                  {{ txn.status }}
                </span>
              </td>
              <td class="px-6 py-4 relative text-right">
                <div class="relative inline-block text-left">
                  <button
                    class="bg-primary text-white px-4 py-1.5 rounded-full text-xs font-medium shadow hover:bg-secondary transition"
                    (click)="handleStatusButtonClick($event, $index)"
                  >
                    Change Status
                  </button>

                  @if (openDropdownIndex === $index) {
                    <div
                      class="absolute z-50 mt-2 w-40 right-0 bg-white border border-gray-200 rounded-md shadow-xl transition-all animate-fade-in"
                      (clickOutside)="openDropdownIndex = null"
                    >
                      <button
                        class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100"
                        [ngClass]="{ 'bg-green-100': txn.status === 'Paid' }"
                        (click)="changeTransactionStatus(txn, 'Paid'); openDropdownIndex = null"
                      >
                        ✅ Mark as Paid
                      </button>
                      <button
                        class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100"
                        [ngClass]="{ 'bg-yellow-100': txn.status === 'Pending' }"
                        (click)="changeTransactionStatus(txn, 'Pending'); openDropdownIndex = null"
                      >
                        ⏳ Set Pending
                      </button>
                      <button
                        class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100"
                        [ngClass]="{ 'bg-red-100': txn.status === 'Failed' }"
                        (click)="changeTransactionStatus(txn, 'Failed'); openDropdownIndex = null"
                      >
                        ❌ Mark Failed
                      </button>
                    </div>
                  }
                </div>
              </td>
            </tr>

            <!-- Expanded Split-Up -->
            @if (txn.split_up && expandedRows.has($index)) {
              <tr class="bg-gray-50">
                <td colspan="6" class="px-6 pb-4 pt-2">
                  <div class="border border-gray-200 rounded-lg p-4 bg-white">
                    <h3 class="text-xs font-semibold text-gray-500 mb-2">Split-up Details</h3>
                    <div class="overflow-x-auto">
                      <table class="w-full text-sm text-left border rounded-md">
                        <thead class="bg-gray-100 text-gray-600 font-medium">
                          <tr>
                            <th class="px-4 py-2 border border-gray-100">Field</th>
                            <th class="px-4 py-2 border border-gray-100">Amount (₹)</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (field of txn.split_up | keyvalue; track field.key) {
                            <tr>
                              <td class="px-4 py-2 border border-gray-100 text-gray-700">
                                {{ field.key }}
                              </td>
                              <td class="px-4 py-2 border border-gray-100 font-semibold text-gray-800">
                                ₹{{ field.value }}
                              </td>
                            </tr>
                          } @empty {
                            <tr>
                              <td class="px-4 py-2 border border-gray-100 text-gray-700" colspan="2">
                                No Split-Up
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  </div>
                </td>
              </tr>
            }
          }
        } @else {
          <tr>
            <td colspan="6" class="px-6 py-4 text-center text-gray-500 font-medium">
              No transactions available.
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
</div>
